<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/qinlingrong.github.io/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/qinlingrong.github.io/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/qinlingrong.github.io/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/qinlingrong.github.io/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/qinlingrong.github.io/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/qinlingrong.github.io/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/qinlingrong.github.io/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://qlrishui.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/qinlingrong.github.io/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://qlrishui.github.io/"/>





  <title>Hexo</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/qinlingrong.github.io/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/qinlingrong.github.io/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/qinlingrong.github.io/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://qlrishui.github.io/qinlingrong.github.io/2017/08/11/探究fragment转场动画的执行流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinnlingrong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/qinlingrong.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/qinlingrong.github.io/2017/08/11/探究fragment转场动画的执行流程/" itemprop="url">Unbenannt</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-11T21:13:00+08:00">
                2017-08-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##探究fragment转场动画的执行流程</p>
<p>###我们都知道fragment可以设置它的转场动画，来实现fragment之间的切换的动画效果。如下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FragmentManager fragmentManager = getSupportFragmentManager();</span><br><span class="line">FragmentTransaction fragmentTransaction = fragmentManager.beginTransaction();</span><br><span class="line">fragmentTransaction.setCustomAnimations(R.anim.menushow,R.anim.menuhide);</span><br><span class="line">fragmentTransaction.add(R.id.ad_container,new ClsInfoFragment(),&quot;tag1&quot;);</span><br><span class="line">fragmentTransaction.commitAllowingStateLoss();</span><br></pre></td></tr></table></figure></p>
<p>这样简单几句话就可以实现fragment之间的切换效果动画，那其中都经历了什么，我们来跟踪源码看一看流程是怎么走的。</p>
<p>我们先从setCustomAnimations（int enter, int exit）走起，进入源码可见这是一个抽象方法，属于抽象类FragmentTransaction，需要注意的是，此处的exit动画并不适用于出栈动画，如果你试图在这使用它做一个出栈动画是无效的，出栈动画需要用另一个方法<br>setCustomAnimations(enter, exit, popEnter, popExit),第四个参数才是设置出栈动画</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">    /**</span><br><span class="line">     * Set specific animation resources to run for the fragments that are</span><br><span class="line">     * entering and exiting in this transaction. These animations will not be</span><br><span class="line">     * played when popping the back stack.</span><br><span class="line">     *</span><br><span class="line">     * @param enter An animation or animator resource ID used for the enter animation on the</span><br><span class="line">     *              view of the fragment being added or attached.</span><br><span class="line">     * @param exit An animation or animator resource ID used for the exit animation on the</span><br><span class="line">     *             view of the fragment being removed or detached.</span><br><span class="line">     */</span><br><span class="line">    public abstract FragmentTransaction setCustomAnimations(@AnimatorRes @AnimRes int enter,</span><br><span class="line">            @AnimatorRes @AnimRes int exit);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">两个方法的对比            </span><br><span class="line">            </span><br><span class="line">/**</span><br><span class="line">     * Set specific animation resources to run for the fragments that are</span><br><span class="line">     * entering and exiting in this transaction. The &lt;code&gt;popEnter&lt;/code&gt;</span><br><span class="line">     * and &lt;code&gt;popExit&lt;/code&gt; animations will be played for enter/exit</span><br><span class="line">     * operations specifically when popping the back stack.</span><br><span class="line">     *</span><br><span class="line">     * @param enter An animation or animator resource ID used for the enter animation on the</span><br><span class="line">     *              view of the fragment being added or attached.</span><br><span class="line">     * @param exit An animation or animator resource ID used for the exit animation on the</span><br><span class="line">     *             view of the fragment being removed or detached.</span><br><span class="line">     * @param popEnter An animation or animator resource ID used for the enter animation on the</span><br><span class="line">     *                 view of the fragment being readded or reattached caused by</span><br><span class="line">     *                 &#123;@link FragmentManager#popBackStack()&#125; or similar methods.</span><br><span class="line">     * @param popExit An animation or animator resource ID used for the enter animation on the</span><br><span class="line">     *                view of the fragment being removed or detached caused by</span><br><span class="line">     *                &#123;@link FragmentManager#popBackStack()&#125; or similar methods.</span><br><span class="line">     */</span><br><span class="line">    public abstract FragmentTransaction setCustomAnimations(@AnimatorRes @AnimRes int enter,</span><br><span class="line">            @AnimatorRes @AnimRes int exit, @AnimatorRes @AnimRes int popEnter,</span><br><span class="line">            @AnimatorRes @AnimRes int popExit);</span><br></pre></td></tr></table></figure>
<p>因为FragmentTransaction是个抽象类，那么我们找到他的实现类BackStackRecord，位于android.support.v4.app包下。它的setCustomAnimations方法只是简单的将我们传入的参数赋值给自身的变量,并返回自身对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public FragmentTransaction setCustomAnimations(int enter, int exit,</span><br><span class="line">        int popEnter, int popExit) &#123;</span><br><span class="line">    mEnterAnim = enter;</span><br><span class="line">    mExitAnim = exit;</span><br><span class="line">    mPopEnterAnim = popEnter;</span><br><span class="line">    mPopExitAnim = popExit;</span><br><span class="line">    return this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 那我们再来看下一步fragmentTransaction.add(R.id.ad_container,new ClsInfoFragment(),”tag1”)都做了什么。依然还是BackStackRecord类。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> @Override</span><br><span class="line">public FragmentTransaction add(int containerViewId, Fragment fragment, String tag) &#123;</span><br><span class="line">    doAddOp(containerViewId, fragment, tag, OP_ADD);</span><br><span class="line">    return this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> BackStackRecord里的add方法里调用了一个doAddOp方法，源码如下：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> private void doAddOp(int containerViewId, Fragment fragment, String tag, int opcmd) &#123;</span><br><span class="line">    final Class fragmentClass = fragment.getClass();</span><br><span class="line">    final int modifiers = fragmentClass.getModifiers();</span><br><span class="line">    if (fragmentClass.isAnonymousClass() || !Modifier.isPublic(modifiers)</span><br><span class="line">            || (fragmentClass.isMemberClass() &amp;&amp; !Modifier.isStatic(modifiers))) &#123;</span><br><span class="line">        throw new IllegalStateException(&quot;Fragment &quot; + fragmentClass.getCanonicalName()</span><br><span class="line">                + &quot; must be a public static class to be  properly recreated from&quot;</span><br><span class="line">                + &quot; instance state.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fragment.mFragmentManager = mManager;</span><br><span class="line"></span><br><span class="line">    if (tag != null) &#123;</span><br><span class="line">        if (fragment.mTag != null &amp;&amp; !tag.equals(fragment.mTag)) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;Can&apos;t change tag of fragment &quot;</span><br><span class="line">                    + fragment + &quot;: was &quot; + fragment.mTag</span><br><span class="line">                    + &quot; now &quot; + tag);</span><br><span class="line">        &#125;</span><br><span class="line">        fragment.mTag = tag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (containerViewId != 0) &#123;</span><br><span class="line">        if (containerViewId == View.NO_ID) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;Can&apos;t add fragment &quot;</span><br><span class="line">                    + fragment + &quot; with tag &quot; + tag + &quot; to container view with no id&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (fragment.mFragmentId != 0 &amp;&amp; fragment.mFragmentId != containerViewId) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;Can&apos;t change container ID of fragment &quot;</span><br><span class="line">                    + fragment + &quot;: was &quot; + fragment.mFragmentId</span><br><span class="line">                    + &quot; now &quot; + containerViewId);</span><br><span class="line">        &#125;</span><br><span class="line">        fragment.mContainerId = fragment.mFragmentId = containerViewId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addOp(new Op(opcmd, fragment));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 这里先是将fragment关联到fragmentmanager对象，为fragment设置tag，然后调用一个addOp(new Op(opcmd, fragment))方法，opcmd是上面传入的一个OP_ADD常量，在BackStackRecord中有一系列常量如<code>OP_HIDE</code>，<code>OP_SHOW</code>，<code>OP_DETACH</code>，<code>OP_ATTACH</code>，<code>OP_ADD</code>等等来控制下面的流程走向。让我们进入addOp方法：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> void addOp(Op op) &#123;</span><br><span class="line">    mOps.add(op);</span><br><span class="line">    op.enterAnim = mEnterAnim;</span><br><span class="line">    op.exitAnim = mExitAnim;</span><br><span class="line">    op.popEnterAnim = mPopEnterAnim;</span><br><span class="line">    op.popExitAnim = mPopExitAnim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 在这里就将setCustomAnimations方法传入的值给一个Op对象进行赋值并将它添加到一个list里备用。Op是定义在BackStackRecord类里的一个静态final类，BackStackRecord里有一个ArrayList管理这些对应的Op对象。</p>
<p>我们再来看下一步fragmentTransaction.commitAllowingStateLoss()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public int commitAllowingStateLoss() &#123;</span><br><span class="line">    return commitInternal(true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟踪到commitInternal方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">int commitInternal(boolean allowStateLoss) &#123;</span><br><span class="line">    if (mCommitted) throw new IllegalStateException(&quot;commit already called&quot;);</span><br><span class="line">    if (FragmentManagerImpl.DEBUG) &#123;</span><br><span class="line">        Log.v(TAG, &quot;Commit: &quot; + this);</span><br><span class="line">        LogWriter logw = new LogWriter(TAG);</span><br><span class="line">        PrintWriter pw = new PrintWriter(logw);</span><br><span class="line">        dump(&quot;  &quot;, null, pw, null);</span><br><span class="line">        pw.close();</span><br><span class="line">    &#125;</span><br><span class="line">    mCommitted = true;</span><br><span class="line">    if (mAddToBackStack) &#123;</span><br><span class="line">        mIndex = mManager.allocBackStackIndex(this);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        mIndex = -1;</span><br><span class="line">    &#125;</span><br><span class="line">    mManager.enqueueAction(this, allowStateLoss);</span><br><span class="line">    return mIndex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Fragemntmanager也是个抽象类，它的实现为FragmentManagerImpl类，进入源码跟踪可知<br>这个方法调用了fragemntmanager的enqueueAction(OpGenerator action, boolean allowStateLoss)方法，它的实现在FragmentManagerImpl 的 enqueueAction方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Adds an action to the queue of pending actions.</span><br><span class="line"> *</span><br><span class="line"> * @param action the action to add</span><br><span class="line"> * @param allowStateLoss whether to allow loss of state information</span><br><span class="line"> * @throws IllegalStateException if the activity has been destroyed</span><br><span class="line"> */</span><br><span class="line">public void enqueueAction(OpGenerator action, boolean allowStateLoss) &#123;</span><br><span class="line">    if (!allowStateLoss) &#123;</span><br><span class="line">        checkStateLoss();</span><br><span class="line">    &#125;</span><br><span class="line">    synchronized (this) &#123;</span><br><span class="line">        if (mDestroyed || mHost == null) &#123;</span><br><span class="line">            if (allowStateLoss) &#123;</span><br><span class="line">                // This FragmentManager isn&apos;t attached, so drop the entire transaction.</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            throw new IllegalStateException(&quot;Activity has been destroyed&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (mPendingActions == null) &#123;</span><br><span class="line">            mPendingActions = new ArrayList&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        mPendingActions.add(action);</span><br><span class="line">        scheduleCommit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到这方法中执行了一个scheduleCommit()方法,继续往下走进去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Schedules the execution when one hasn&apos;t been scheduled already. This should happen</span><br><span class="line"> * the first time &#123;@link #enqueueAction(OpGenerator, boolean)&#125; is called or when</span><br><span class="line"> * a postponed transaction has been started with</span><br><span class="line"> * &#123;@link Fragment#startPostponedEnterTransition()&#125;</span><br><span class="line"> */</span><br><span class="line">private void scheduleCommit() &#123;</span><br><span class="line">    synchronized (this) &#123;</span><br><span class="line">        boolean postponeReady =</span><br><span class="line">                mPostponedTransactions != null &amp;&amp; !mPostponedTransactions.isEmpty();</span><br><span class="line">        boolean pendingReady = mPendingActions != null &amp;&amp; mPendingActions.size() == 1;</span><br><span class="line">        if (postponeReady || pendingReady) &#123;</span><br><span class="line">            mHost.getHandler().removeCallbacks(mExecCommit);</span><br><span class="line">            mHost.getHandler().post(mExecCommit);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到这个方法里先remove掉主线程handler里已经存在的退出的动画任务 mExecCommit,<br>mExecCommit是个ruannable线程任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Runnable mExecCommit = new Runnable() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        execPendingActions();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后在加入新的退出动画任务</p>
<p>这个任务里执行了execPendingActions()方法，我们继续往下走</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Only call from main thread!</span><br><span class="line"> */</span><br><span class="line">public boolean execPendingActions() &#123;</span><br><span class="line">    ensureExecReady(true);</span><br><span class="line"></span><br><span class="line">    boolean didSomething = false;</span><br><span class="line">    while (generateOpsForPendingActions(mTmpRecords, mTmpIsPop)) &#123;</span><br><span class="line">        mExecutingActions = true;</span><br><span class="line">        try &#123;</span><br><span class="line">            removeRedundantOperationsAndExecute(mTmpRecords, mTmpIsPop);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            cleanupExec();</span><br><span class="line">        &#125;</span><br><span class="line">        didSomething = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    doPendingDeferredStart();</span><br><span class="line">    burpActive();</span><br><span class="line"></span><br><span class="line">    return didSomething;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到这个方法里先执行了ensureExecReady(true)去执行前置的一些操作，然后在while循环里将挂起操作中的所有东西添加到记录, 以及它们是添加还是 pop 操作 isPop，是否需要操作等。然后进入<br>removeRedundantOperationsAndExecute(mTmpRecords, mTmpIsPop)方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Remove redundant BackStackRecord operations and executes them. This method merges operations</span><br><span class="line"> * of proximate records that allow reordering. See</span><br><span class="line"> * &#123;@link FragmentTransaction#setReorderingAllowed(boolean)&#125;.</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * For example, a transaction that adds to the back stack and then another that pops that</span><br><span class="line"> * back stack record will be optimized to remove the unnecessary operation.</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * Likewise, two transactions committed that are executed at the same time will be optimized</span><br><span class="line"> * to remove the redundant operations as well as two pop operations executed together.</span><br><span class="line"> *</span><br><span class="line"> * @param records The records pending execution</span><br><span class="line"> * @param isRecordPop The direction that these records are being run.</span><br><span class="line"> */</span><br><span class="line">private void removeRedundantOperationsAndExecute(ArrayList&lt;BackStackRecord&gt; records,</span><br><span class="line">        ArrayList&lt;Boolean&gt; isRecordPop) &#123;</span><br><span class="line">    if (records == null || records.isEmpty()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (isRecordPop == null || records.size() != isRecordPop.size()) &#123;</span><br><span class="line">        throw new IllegalStateException(&quot;Internal error with the back stack records&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Force start of any postponed transactions that interact with scheduled transactions:</span><br><span class="line">    executePostponedTransaction(records, isRecordPop);</span><br><span class="line"></span><br><span class="line">    final int numRecords = records.size();</span><br><span class="line">    int startIndex = 0;</span><br><span class="line">    for (int recordNum = 0; recordNum &lt; numRecords; recordNum++) &#123;</span><br><span class="line">        final boolean canReorder = records.get(recordNum).mReorderingAllowed;</span><br><span class="line">        if (!canReorder) &#123;</span><br><span class="line">            // execute all previous transactions</span><br><span class="line">            if (startIndex != recordNum) &#123;</span><br><span class="line">                executeOpsTogether(records, isRecordPop, startIndex, recordNum);</span><br><span class="line">            &#125;</span><br><span class="line">            // execute all pop operations that don&apos;t allow reordering together or</span><br><span class="line">            // one add operation</span><br><span class="line">            int reorderingEnd = recordNum + 1;</span><br><span class="line">            if (isRecordPop.get(recordNum)) &#123;</span><br><span class="line">                while (reorderingEnd &lt; numRecords</span><br><span class="line">                        &amp;&amp; isRecordPop.get(reorderingEnd)</span><br><span class="line">                        &amp;&amp; !records.get(reorderingEnd).mReorderingAllowed) &#123;</span><br><span class="line">                    reorderingEnd++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            executeOpsTogether(records, isRecordPop, recordNum, reorderingEnd);</span><br><span class="line">            startIndex = reorderingEnd;</span><br><span class="line">            recordNum = reorderingEnd - 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (startIndex != numRecords) &#123;</span><br><span class="line">        executeOpsTogether(records, isRecordPop, startIndex, numRecords);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这方法里，先执行executePostponedTransaction强制的将保存的Transactions除了当前的，其他的清除掉，然后循环取得BackStackRecord的list里的每一个对象来判断是否要执行executeOpsTogether操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Executes a subset of a list of BackStackRecords, all of which either allow reordering or</span><br><span class="line"> * do not allow ordering.</span><br><span class="line"> * @param records A list of BackStackRecords that are to be executed</span><br><span class="line"> * @param isRecordPop The direction that these records are being run.</span><br><span class="line"> * @param startIndex The index of the first record in &lt;code&gt;records&lt;/code&gt; to be executed</span><br><span class="line"> * @param endIndex One more than the final record index in &lt;code&gt;records&lt;/code&gt; to executed.</span><br><span class="line"> */</span><br><span class="line">private void executeOpsTogether(ArrayList&lt;BackStackRecord&gt; records,</span><br><span class="line">        ArrayList&lt;Boolean&gt; isRecordPop, int startIndex, int endIndex) &#123;</span><br><span class="line">    final boolean allowReordering = records.get(startIndex).mReorderingAllowed;</span><br><span class="line">    boolean addToBackStack = false;</span><br><span class="line">    if (mTmpAddedFragments == null) &#123;</span><br><span class="line">        mTmpAddedFragments = new ArrayList&lt;&gt;();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        mTmpAddedFragments.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    mTmpAddedFragments.addAll(mAdded);</span><br><span class="line">    Fragment oldPrimaryNav = getPrimaryNavigationFragment();</span><br><span class="line">    for (int recordNum = startIndex; recordNum &lt; endIndex; recordNum++) &#123;</span><br><span class="line">        final BackStackRecord record = records.get(recordNum);</span><br><span class="line">        final boolean isPop = isRecordPop.get(recordNum);</span><br><span class="line">        if (!isPop) &#123;</span><br><span class="line">            oldPrimaryNav = record.expandOps(mTmpAddedFragments, oldPrimaryNav);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            oldPrimaryNav = record.trackAddedFragmentsInPop(mTmpAddedFragments, oldPrimaryNav);</span><br><span class="line">        &#125;</span><br><span class="line">        addToBackStack = addToBackStack || record.mAddToBackStack;</span><br><span class="line">    &#125;</span><br><span class="line">    mTmpAddedFragments.clear();</span><br><span class="line"></span><br><span class="line">    if (!allowReordering) &#123;</span><br><span class="line">        FragmentTransition.startTransitions(this, records, isRecordPop, startIndex, endIndex,</span><br><span class="line">                false);</span><br><span class="line">    &#125;</span><br><span class="line">    executeOps(records, isRecordPop, startIndex, endIndex);</span><br><span class="line"></span><br><span class="line">    int postponeIndex = endIndex;</span><br><span class="line">    if (allowReordering) &#123;</span><br><span class="line">        ArraySet&lt;Fragment&gt; addedFragments = new ArraySet&lt;&gt;();</span><br><span class="line">        addAddedFragments(addedFragments);</span><br><span class="line">        postponeIndex = postponePostponableTransactions(records, isRecordPop,</span><br><span class="line">                startIndex, endIndex, addedFragments);</span><br><span class="line">        makeRemovedFragmentsInvisible(addedFragments);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (postponeIndex != startIndex &amp;&amp; allowReordering) &#123;</span><br><span class="line">        // need to run something now</span><br><span class="line">        FragmentTransition.startTransitions(this, records, isRecordPop, startIndex,</span><br><span class="line">                postponeIndex, true);</span><br><span class="line">        moveToState(mCurState, true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (int recordNum = startIndex; recordNum &lt; endIndex; recordNum++) &#123;</span><br><span class="line">        final BackStackRecord record = records.get(recordNum);</span><br><span class="line">        final boolean isPop = isRecordPop.get(recordNum);</span><br><span class="line">        if (isPop &amp;&amp; record.mIndex &gt;= 0) &#123;</span><br><span class="line">            freeBackStackIndex(record.mIndex);</span><br><span class="line">            record.mIndex = -1;</span><br><span class="line">        &#125;</span><br><span class="line">        record.runOnCommitRunnables();</span><br><span class="line">    &#125;</span><br><span class="line">    if (addToBackStack) &#123;</span><br><span class="line">        reportBackStackChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在这个方法里也循环的去取得每一个FragmentTransaction对应操作集的是否是执行出栈分别跳转到对应的方法中执行<figure class="highlight plain"><figcaption><span>(!isPop) &#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    oldPrimaryNav = record.expandOps(mTmpAddedFragments, oldPrimaryNav);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    oldPrimaryNav = record.trackAddedFragmentsInPop(mTmpAddedFragments, oldPrimaryNav);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这些方法中都有大致相同的逻辑，判断Op对象里的对应的状态值进行add，hide，remove等操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">switch (op.cmd) &#123;</span><br><span class="line">    case OP_ADD:</span><br><span class="line">    case OP_ATTACH:</span><br><span class="line">        added.add(op.fragment);</span><br><span class="line">        break;</span><br><span class="line">    case OP_REMOVE:</span><br><span class="line">    case OP_DETACH: &#123;</span><br><span class="line">        added.remove(op.fragment);</span><br><span class="line">        if (op.fragment == oldPrimaryNav) &#123;</span><br><span class="line">            mOps.add(opNum, new Op(OP_UNSET_PRIMARY_NAV, op.fragment));</span><br><span class="line">            opNum++;</span><br><span class="line">            oldPrimaryNav = null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line">    </span><br><span class="line">    。。。</span><br></pre></td></tr></table></figure>
<p>将各种操作封装成Op并添加，最后在executePopOps方法中通过循环给每个fragment调用setNextAnim设置动画属性。如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">void executePopOps(boolean moveToState) &#123;</span><br><span class="line">    for (int opNum = mOps.size() - 1; opNum &gt;= 0; opNum--) &#123;</span><br><span class="line">        final Op op = mOps.get(opNum);</span><br><span class="line">        Fragment f = op.fragment;</span><br><span class="line">        if (f != null) &#123;</span><br><span class="line">            f.setNextTransition(FragmentManagerImpl.reverseTransit(mTransition),</span><br><span class="line">                    mTransitionStyle);</span><br><span class="line">        &#125;</span><br><span class="line">        switch (op.cmd) &#123;</span><br><span class="line">            case OP_ADD:</span><br><span class="line">                f.setNextAnim(op.popExitAnim);</span><br><span class="line">                mManager.removeFragment(f);</span><br><span class="line">                break;</span><br><span class="line">            case OP_REMOVE:</span><br><span class="line">                f.setNextAnim(op.popEnterAnim);</span><br><span class="line">                mManager.addFragment(f, false);</span><br><span class="line">                break;</span><br><span class="line">            case OP_HIDE:</span><br><span class="line">                f.setNextAnim(op.popEnterAnim);</span><br><span class="line">                mManager.showFragment(f);</span><br><span class="line">                break;</span><br><span class="line">            case OP_SHOW:</span><br><span class="line">                f.setNextAnim(op.popExitAnim);</span><br><span class="line">                mManager.hideFragment(f);</span><br><span class="line">                break;</span><br><span class="line">            case OP_DETACH:</span><br><span class="line">                f.setNextAnim(op.popEnterAnim);</span><br><span class="line">                mManager.attachFragment(f);</span><br><span class="line">                break;</span><br><span class="line">            case OP_ATTACH:</span><br><span class="line">                f.setNextAnim(op.popExitAnim);</span><br><span class="line">                mManager.detachFragment(f);</span><br><span class="line">                break;</span><br><span class="line">            case OP_SET_PRIMARY_NAV:</span><br><span class="line">                mManager.setPrimaryNavigationFragment(null);</span><br><span class="line">                break;</span><br><span class="line">            case OP_UNSET_PRIMARY_NAV:</span><br><span class="line">                mManager.setPrimaryNavigationFragment(f);</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                throw new IllegalArgumentException(&quot;Unknown cmd: &quot; + op.cmd);</span><br><span class="line">        &#125;</span><br><span class="line">        if (!mReorderingAllowed &amp;&amp; op.cmd != OP_REMOVE &amp;&amp; f != null) &#123;</span><br><span class="line">            mManager.moveFragmentToExpectedState(f);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (!mReorderingAllowed &amp;&amp; moveToState) &#123;</span><br><span class="line">        mManager.moveToState(mManager.mCurState, true);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当fragmentmanager在moveToState或者completeShowHideFragment等操作时，都会去调用getNextAnim方法获得动画对象，或者通过loadAnimation方法去间接调用getNextAnim方法获得动画对象，最终在后续操作中完成动画的执行。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://qlrishui.github.io/qinlingrong.github.io/2017/04/06/hook Instrumentation 实现对Activity生命周期的监听/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinnlingrong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/qinlingrong.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/qinlingrong.github.io/2017/04/06/hook Instrumentation 实现对Activity生命周期的监听/" itemprop="url">Unbenannt</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-06T22:20:00+08:00">
                2017-04-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##hook Instrumentation 实现对Activity生命周期的监听</p>
<p>###如何hook主线程<br>首先要先找对hook的点，在Application中有一个隐藏的mLoadedApk，它在Application之初便保存了程序的所有信息mLoadedApk = ContextImpl.getImpl(context).mPackageInfo;我们可以看到这个LoadedApk里包含了ActivityThread，这个ActivityThread里又有一个sCurrentActivityThread，sCurrentActivityThread指的是他自己本身，所以这个sCurrentActivityThread就是我们想要hook住的主线程对象，在这个主线程对象里我们又可以hook他的Instrumentation对象以实现对activity对象的各个生命周期的回调的监听。</p>
<p>如代码所示，我们需要在Application启动时去替换主线程的Instrumentation:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">package com.example.zhanqian.myapplication;</span><br><span class="line">import android.app.Activity;</span><br><span class="line">import android.app.Application;</span><br><span class="line">import android.app.Instrumentation;</span><br><span class="line">import android.util.Log;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.InvocationTargetException;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">/**</span><br><span class="line"> * Created by zhangqian on 2016/5/27.</span><br><span class="line"> */</span><br><span class="line">public class MyApplication extends Application &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate() &#123;</span><br><span class="line">        super.onCreate();</span><br><span class="line">        try &#123;</span><br><span class="line">            hookActivity(this);</span><br><span class="line">        &#125; catch (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public void hookActivity( Application application) throws NoSuchFieldException, IllegalAccessException, NoSuchMethodException, InvocationTargetException &#123;</span><br><span class="line">        Class&lt;?&gt; clz = application.getClass();</span><br><span class="line">        Field field = clz.getField(&quot;mLoadedApk&quot;);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        Class &lt;?&gt; clzz = field.getType();</span><br><span class="line">        Field threadF = clzz.getDeclaredField(&quot;mActivityThread&quot;);</span><br><span class="line">        threadF.setAccessible(true);</span><br><span class="line">        Class&lt;?&gt; thread = threadF.getType();</span><br><span class="line">        Method currentActivityThread= thread.getDeclaredMethod(&quot;currentActivityThread&quot;);</span><br><span class="line">        currentActivityThread.setAccessible(true);</span><br><span class="line">        /**获取主线程对象**/</span><br><span class="line">        Object activityThreadObject=currentActivityThread.invoke(null);</span><br><span class="line">        Field mInstrumentationField = thread.getDeclaredField(&quot;mInstrumentation&quot;);</span><br><span class="line">        mInstrumentationField.setAccessible(true);</span><br><span class="line">        Instrumentation mInsertInstrumentation = new InsertInstrumentation();</span><br><span class="line">        mInstrumentationField.set(activityThreadObject,mInsertInstrumentation);</span><br><span class="line">    &#125;</span><br><span class="line">    private static class InsertInstrumentation extends android.app.Instrumentation&#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void callActivityOnResume(Activity activity) &#123;</span><br><span class="line">            super.callActivityOnResume(activity);</span><br><span class="line">            Log.i(&quot;qinlingrong&quot;,&quot;---------------hook Activity OnResume -----------------&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        @Override</span><br><span class="line">        public void callActivityOnPause(Activity activity) &#123;</span><br><span class="line">            super.callActivityOnPause(activity);</span><br><span class="line">            Log.i(&quot;qinlingrong&quot;,&quot;---------------hook Activity OnPause -----------------&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://qlrishui.github.io/qinlingrong.github.io/2017/04/04/android屏幕解锁新解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinnlingrong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/qinlingrong.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/qinlingrong.github.io/2017/04/04/android屏幕解锁新解/" itemprop="url">Unbenannt</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-04T21:50:00+08:00">
                2017-04-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##android屏幕解锁新解</p>
<p>最近因为一些事接触到android屏幕解锁这块，刚开始查询网上资料，绝大部分以keyguardLock 来进行获取屏幕锁和接触屏幕锁，其思路如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> KeyguardManager keyguardManager = (KeyguardManager)getSystemService(KEYGUARD_SERVICE); </span><br><span class="line">KeyguardLock keyguardLock = keyguardManager.newKeyguardLock(&quot;glapp&quot;);</span><br><span class="line"> keyguardLock.disableKeyguard();</span><br><span class="line">获取当前屏幕锁并解锁；</span><br><span class="line"></span><br><span class="line">KeyguardManager keyguardManager = (KeyguardManager)getSystemService(KEYGUARD_SERVICE); </span><br><span class="line"> KeyguardLock keyguardLock = keyguardManager.newKeyguardLock(&quot;glapp&quot;); keyguardLock.reenableKeyguard();</span><br></pre></td></tr></table></figure>
<p>然后在相应位置 释放持有的屏幕锁</p>
<p>但是这个思路有一个问题，在最后一次退出应用的时候由于释放的屏幕锁被系统回收，系统会再次锁屏，造成不好的用户体验，</p>
<p>经过翻阅api，发现有一个更好的解决方式：</p>
<p>在window对象中，存在这样一个flags ：WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD</p>
<p>位于 package android.view.WindowManager中。</p>
<p>其注释如下：</p>
<pre><code>/** Window flag: when set the window will cause the keyguard to
 * be dismissed, only if it is not a secure lock keyguard.  Because such
 * a keyguard is not needed for security, it will never re-appear if
 * the user navigates to another window (in contrast to
 * {@link #FLAG_SHOW_WHEN_LOCKED}, which will only temporarily
 * hide both secure and non-secure keyguards but ensure they reappear
 * when the user moves to another UI that doesn&apos;t hide them).
 * If the keyguard is currently active and is secure (requires an
 * unlock pattern) than the user will still need to confirm it before
 * seeing this window, unless {@link #FLAG_SHOW_WHEN_LOCKED} has
 * also been set.
 */
public static final int FLAG_DISMISS_KEYGUARD = 0x00400000;
</code></pre><p>其大意为：</p>
<p>窗口的标志： 当键盘锁不是安全的的时候（即基本的屏幕锁）设置该flags后该窗口显示会导致键盘锁被解锁。因为这种键盘锁不需要用于安全，如果用户导航到另一个窗口,它(键盘锁)将永远不会重新出现（相对于{@link #FLAG_SHOW_WHEN_LOCKED}，这只是暂时隐藏安全和非安全的 keyguards，但r如果系统确保当用户移到另一个用户界面（即不在这个应用中），并不设置他们显示方式的时候，它们（键盘锁）又会出现（即键盘锁又恢复到了原来的正常状态而不是被获取释放等等））。如果键盘锁当前处于活动状态，并且是安全的 （比如手势屏幕解锁图案） 用户在看到自己的界面前仍然将需要进行解锁，除非用户还设置了 {@link #FLAG_SHOW_WHEN_LOCKED}。</p>
<p>So 用法如下 在你的oncreate()方法中，在你setContentView之前<br>你只需要为 window 添加相应flags：<br>getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON|WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD);<br>setContentView(R.layout.lockscreen);<br>即可大功告成！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://qlrishui.github.io/qinlingrong.github.io/2017/03/17/初探Fragment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qinnlingrong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/qinlingrong.github.io/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/qinlingrong.github.io/2017/03/17/初探Fragment/" itemprop="url">Unbenannt</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-17T01:08:09+08:00">
                2017-03-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="初探Fragment"><a href="#初探Fragment" class="headerlink" title="初探Fragment"></a>初探Fragment</h1><h2 id="Fragment是什么"><a href="#Fragment是什么" class="headerlink" title="Fragment是什么"></a>Fragment是什么</h2><ul>
<li>Fragmeng简介： </li>
</ul>
<p>自从Android 3.0中引入fragments 的概念,根据词海的翻译可以译为:碎片、片段。其上的是为了解决不同屏幕分辩率的动态和灵活UI设计。大屏幕如平板小屏幕如手机，平板电脑的设计使得其有更多的空间来放更多的UI组件，而多出来的空间存放UI使其会产生更多的交互，从而诞生了fragments 。fragments 的设计不需要你来亲自管理view hierarchy 的复杂变化，通过将Activity 的布局分散到frament 中，可以在运行时修改activity 的外观，并且由activity 管理的back stack 中保存些变化。</p>
<ul>
<li>Fragmeng优点：</li>
</ul>
<p>Fragment可以使你能够将activity分离成多个可重用的组件，每个都有它自己的生命周期和UI。</p>
<p>Fragment可以轻松得创建动态灵活的UI设计，可以适应于不同的屏幕尺寸。从手机到平板电脑。</p>
<p>Fragment是一个独立的模块,紧紧地与activity绑定在一起。可以运行中动态地移除、加入、交换等。</p>
<p>Fragment提供一个新的方式让你在不同的安卓设备上统一你的UI。</p>
<p>Fragment 解决Activity间的切换不流畅，轻量切换。</p>
<p>Fragment 替代TabActivity做导航，性能更好。</p>
<p>Fragment 在4.2.版本中新增嵌套fragmeng使用方法，能够生成更好的界面效果。</p>
<p>Fragment做局部内容更新更方便，原来为了到达这一点要把多个布局放到一个activity里面，现在可以用多Fragment来代替，只有在需要的时候才加载Fragment，提高性能</p>
<ul>
<li>Fragmeng使用</li>
</ul>
<ol>
<li>两种添加方法</li>
</ol>
<p>在activity的layout文件中显式的添加一个fragment</p>
<p>通过代码将fragment添加到一个已存在的ViewGroup，例如viewpager或者一个FrameLayout</p>
<ol>
<li>Fragmeng与Activity交互</li>
</ol>
<p>Fragmeng通过getActivity()获得所在Activity上下文,需要注意的是getAcitivy()有可能为空</p>
<p>解决办法：</p>
<p>更”安全”的方法：(对于Fragment已经onDetach这种情况，我们应该避免在这之后再去调用宿主Activity对象，比如取消这些异步任务，但我们的团队可能会有粗心大意的情况，所以下面给出的这个方案会保证安全)<br>在Fragment基类里设置一个Activity mActivity的全局变量，在onAttach(Activity activity)里赋值，使用mActivity代替getActivity()，保证Fragment即使在onDetach后，仍持有Activity的引用（有引起内存泄露的风险，但是异步任务没停止的情况下，本身就可能已内存泄漏，相比Crash，这种做法“安全”些），即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">protected Activity mActivity;</span><br><span class="line">@Override</span><br><span class="line">public void onAttach(Activity activity) &#123;</span><br><span class="line">    super.onAttach(activity);</span><br><span class="line">    this.mActivity = activity;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">*  如果你用了support 23的库，上面的方法会提示过时，有强迫症的小伙伴，可以用下面的方法代替</span><br><span class="line">*/</span><br><span class="line">@Override</span><br><span class="line">public void onAttach(Context context) &#123;</span><br><span class="line">    super.onAttach(context);</span><br><span class="line">    this.mActivity = (Activity)context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Activity通过getFragmentManager()获得Fragmeng实例(findFragmentById,findFragmentByTag);</p>
<p>通过FragmentTransaction可以增加、移除或者代替Fragments；</p>
<p>通过fragmentTransaction.addToBackStack()可以把fragmeng保存到栈，响应后退按钮；</p>
<p>Activity与fragment相互调用方法接口还可以通过Activity的<code>onAttachFragment</code>方法获得fragment的实例从而调用fragment的接口方法，而fragment可以通过<code>onAttach</code>获得父Acitivy的实例来调用相应的方法接口。如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import android.app.Fragment;</span><br><span class="line">/**</span><br><span class="line"> * @author:zhangqian</span><br><span class="line"> * @time:2017/3/17</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">public class TestActivity extends Activity &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    private FragmentListener listener;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onAttachFragment(Fragment fragment) &#123;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            if(fragment instanceof TestFragment)&#123;</span><br><span class="line">                listener = (TestFragment)fragment;</span><br><span class="line">                listener.todo();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        super.onAttachFragment(fragment);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @author:zhangqian</span><br><span class="line"> * @time:2017/3/17</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">public class TestFragment extends Fragment implements FragmentListener &#123;</span><br><span class="line"></span><br><span class="line">    private MainActivity mActivity;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onAttach(Context context) &#123;</span><br><span class="line">        super.onAttach(context);</span><br><span class="line">        mActivity = (MainActivity) context;</span><br><span class="line">        mActivity.getData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void todo() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Qinnlingrong</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/qinlingrong.github.io/archives/">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">Artikel</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qinnlingrong</span>

  
</div>


  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/qinlingrong.github.io/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/qinlingrong.github.io/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/qinlingrong.github.io/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/qinlingrong.github.io/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/qinlingrong.github.io/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/qinlingrong.github.io/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/qinlingrong.github.io/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/qinlingrong.github.io/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/qinlingrong.github.io/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
